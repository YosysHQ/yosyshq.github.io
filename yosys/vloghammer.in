@header VlogHammer@

<h1>VlogHammer</h1>

<p>VlogHammer is a Verilog regression tester used to verify the correctness of
Yosys's Verilog frontend. At the moment VlogHammer only tests combinatorial
circuits described using Verilog expressions.</p>

<p>VlogHammer also exposed a couple of bugs in other programs. Here is a
list of currently open bugs found using VlogHammer:</p>

<p><table style="margin-left: 2em; font-size: small;">
<tr><td width="120"><strong>Bug ID</strong></td><td width="120"><strong>Last checked</strong></td><td><strong>Title</strong></td></tr>
@vloghammer_bugs_open@
</table></p>

<p>And here is a list of now closed bugs found using VlogHammer:</p>

<p><table style="margin-left: 2em; font-size: small;">
<tr><td width="120"><strong>Bug ID</strong></td><td width="120"><strong>Fixed in</strong></td><td><strong>Title</strong></td></tr>
@vloghammer_bugs_closed@
</table></p>

<p>The latest publicly released VlogHammer report can be viewed <a
href="files/vloghammer_report.html">here</a> (use of Google Chrome or Mozilla
Firefox is highly recommended). The text below describes what VlogHammer does
and how to interpret the report. So keep reading! Alternatively watch <a
href="http://www.youtube.com/watch?v=CFR-TP5nukc">the screencast</a> for a
quick overview.</p>

<p>VlogHammer compares the implementation generated by Yosys with the
implementations generated by the following proprietary free-to-use tools:</p>

<ul>
<li>Xilinx Vivado WebPack</li>
<li>Xilinx ISE (XST) WebPack</li>
<li>Altera Quartus Web Edition</li>
</ul>

<p>In addition the behavior of the generated circuits is compared of the behavior
described in the original Verilog code, as interpreted by the following
Verilog Simulators:</p>

<ul>
<li>Xilinx Isim (bundled with Xilinx ISE)</li>
<li>Xilinx XSim (bundled with Xilinx Vivado)</li>
<li>Mentor Modelsim (bundled with Altera Quartus II)</li>
<li>Icarus Verilog (free software)</li>
</ul>

<p>I have found bugs in Yosys and all of the above tools (with the exception of
Modelsim) using VlogHammer. The bugs in Yosys have been fixed and I share
my results in the hope that it will help the vendors of the other tools to
fix the bugs in their programs.</p>

<p>The VlogHammer source code can be found on GitHub: <a
href="https://github.com/YosysHQ/VlogHammer">https://github.com/YosysHQ/VlogHammer</a></p>

<p>The name VlogHammer is inspired by the MC Hammer project from the AArch64
LLVM target. They got the cooler name but we got better google results. :)</p> 

<h2>Scope of Tests</h2>

<p>VlogHammer is using many auto-generated test cases and a few hand-written test
cases. The tests do not use behavioral modeling at the moment and concentrate
on correct interpretation of Verilog expressions. Our experience with VlogHammer
shows that while synthesis of Verilog expressions is not particular hard to do,
it is hard-to-do-right for all corner cases. Thus we exposed bugs in Yosys as
well as all three 3rd party synthesis tools under test.</p>

<p>While the 3rd party tools are only used for simple logic synthesis, Yosys is used
in various ways within VlogHammer, intensively testing the following sub-systems
within Yosys:</p>

<ul>
<li>The Verilog frontend, especially
<ul>
<li>The Verilog to RTL netlist generator and</li>
<li>the Verilog AST const-folder.</li>
</ul>
<li>The const evaluator for Yosys's coarse- and fine-grain internal representation</li>
<li>The standard synthesis pipeline in Yosys (excluding sequential optimizations such as FSM extraction)</li>
<li>The built-in SAT solver and the SAT models for all internal cell types.</li>
</ul>

<h2>Procedure</h2>

The following procedure is used in VlogHammer

<dl>
<dt><b>Test case generation</b></dt>
<dd>The auto-generated test cases are generated using file names following the
pattern <tt>rtl/<i>&lt;category&gt;</i>_<i>&lt;id&gt;</i>.v</tt> and the
hand-written tests are copied to the <tt>rtl/</tt> directory. This is usually
done as a separate step, allowing for individual selection of test cases
by modifying the <tt>rtl/</tt> directory. As a full run of VlogHammer may
take a couple of days of CPU time, manually selecting individual tests is
recommended for most situations. All further steps are conveniently wrapped
using the <tt>make world</tt> command.</dd>
<p/>
<dt><b>Synthesis</b></dt>
<dd>Yosys and the 3rd party synthesis tools are used to create Verilog netlists
for the RTL input. This step creates <tt>syn_<i>&lt;tool&gt;</i>/</tt> directories
with one netlist file per test case.</dd>
<p/>
<dt><b>Checking</b></dt>
<dd>The Yosys SAT solver is used to verify the synthesis results against the
Yosys coarse-grain RTL representation of the original Verilog input. Synthesizeable
models of the xilinx and Altera technology cells are used to create SAT
models for the outputs of the 3rd party tools. Test cases where any of this
verifications fail are marked for report generation. This step creates the
<tt>check_<i>&lt;tool&gt;</i>/</tt> and <tt>cache_<i>&lt;tool&gt;</i>/</tt>
directories.</dd>
<p/>
<dt><b>Report Generation</b></dt>
<dd>For each test case that resulted in an error in the <i>Checking</i> step,
a detailed report is generated. The following steps are performed during this
report generation:
<ul style="margin:0px">
<li>Formal verification of all synthesis results and the Yosys RTL
representation against each other.</li>
<li>Simulation of synthesis results and original Verilog using the counter-examples
from the previous step as well as random bit patterns as test vectors.</li>
<li>Simulation using the Yosys internal const evaluation framework using the same
test vectors. Cross-verification of this results with the forward-solutions from the
SAT models for the same input.</li>
<li>Generation of HTML reports with the results of this tests.</li>
</ul></dd>
<p/>
<dt><b>Summary Report</b></dt>
<dd>All individual reports are bundled in a single large HTML file that can
easily be distributed and browsed on a per-tool basis. The latter is especially
useful as the target audience of this reports is primarily interested in
the test cases that cause problems with their own tool.</dd>
</dl>

<h2>How to read VlogHammer reports</h2>

<p>The VlogHammer report is released as single interactive HTML page. It has a (top)
navigation bar that allows browsing the individual reports, narrowing the reports
to those that only concern an individual tool, and provides a drop-down menu for
directly going to the individual report for a test case.</p>

<p>The report for an individual test case consists of 4 parts:</p>

<ol>
<li>Informal messages, such as the list of synthesis and simulation programs
that VlogHammer thinks have troubles with the test case. Note that the Yosys
synthesis features are listed as "yosys" and the constant evaluation and SAT
solving capabilities are listed as "yosim", although there is no actual
software package that is distributed under the name "yosim".</li>
<li>A table summarising the VlogHammer results for this test case.</li>
<li>The Verilog source-code for the test case and a test bench that also
contains the test vectors used. Note that this is not the actual test bench
used by VlogHammer but a simpler stripped-down version of it.</li>
<li>A list of test patterns that produced interesting results, each listing the
input values and the consolidated output values for the different
<tt><i>&lt;simulator&gt;</i>.<i>&lt;synthesizer&gt;</i></tt> combinations. The
<i>&lt;synthesizer&gt;</i> name <tt>rtl</tt> refers to the original Verilog source
code fed into the simulator.</li>
</ol>

<p>The most interesting-looking part of the report is the table. It looks like this:</p>

<img class="show" src="images/vloghammer_table.png" />

<p>In this example Altera Quartus II produces incorrect synthesis results and
Xilinx ISIM produces incorrect simulation results. Modelsim on the other hand
simulates the RTL correctly. So a good starting point for fixing this bug is by
reproducing the bug using Modelsim as known-good reference and the provided
test case and test bench.  In case of the incorrect synthesis this can be done
by trying to verify the synthesis results using Modelsim. In case of the ISIM
bug by comparing ISIM and Modelsim output.</p>

<p>The table can be divided into four regions of interest. The upper-left area
contains results from the SAT checks that compare the different synthesis outputs:</p>

<img class="show" src="images/vloghammer_tableA.png" />

<p>This is of course always a symmetrical matrix and all entries on the main
diagonal are always "PASS" as a logic netlist is always formally equivalent to
itself. This area can contain false-negatives when undefined behavior (such as
results from division by zero) is implemented differently by the different tools.</p>

<p>The line below that matrix contains the results of SAT checking the synthesis
outputs from the different tools against the Yosys RTL representation:</p>

<img class="show" src="images/vloghammer_tableC.png" />

<p>This line should not contain false negatives, as the RTL SAT models in Yosys do
support modeling of undefined behavior (aka. <tt>x</tt>-bits) and only cases where
defined behavior is implemented differently are used to indicate a "FAIL" here.</p>

<p>The lower right line contains checksums of simulation results for the
different simulation tools for the original Verilog code of the test case and
the auto-generated test vectors:</p>

<img class="show" src="images/vloghammer_tableD.png" />

<p>Here we see that ISIM creates a different output for the original Verilog test
case than Modelsim and the Yosys internal const evaluator ("yosim"). Note that
there is no column for Icarus Verilog in this case as Icarus Verilog crashed
for this particular test case. This results are also used by VlogHammer to extract
<tt>x</tt>-bits for the results for each individual test vector. The output of
the synthesized modules is then treated as <tt>x</tt> for the bits that have been
<tt>x</tt> in the RTL simulation of this individual test vector, so that the
implementation of undefined behavior in the different synthesizers does not
effect the checksums.</p>

<p>Finally the upper right region contains the checksums for the testbench outputs
for the synthesized modules:</p>

<img class="show" src="images/vloghammer_tableB.png" />

<p>If a column in this region is different from the other columns, it is because the
simulator returned a different pattern for the <tt>x</tt>-bits during simulation of the
original Verilog code. It is almost certain that two simulators do not return different
data bits for the same synthesized module.</p>

<p>In the right region it is possible to get false-positives, because the SAT
solver could have generated a test pattern for undefined behavior and thus
missed the opportunity to create a test pattern for a real problem (and also
because of hash collisions, but this is very unlikely). However, false negatives
are not possible here. So we know for certain that there is a bug in at least
two tools here, and it is very likely that this two tools are Quartus II
and Xilinx ISIM.</p>

<p>The latest publicly released VlogHammer report can be viewed <a
href="files/vloghammer_report.html">here</a>. Use of Google Chrome or Mozilla
Firefox is highly recommended, as the HTML file uses some JavaScript and is not
tested with other browsers.</p>

<h2>Disclaimer and additional remarks</h2>

<p>The test case discussed above is an example based on a screenshot taken in one
point in time with one version of the tools discussed. It is the authors hope
that in the future all bugs revealed by VlogHammer will be fixed. So it is possible
that by the time you read this, the tools discussed here do not suffer of any
bug that can be found by VlogHammer.</p>

<p>In fairness I have to add that I have found more bugs in Yosys using VlogHammer
than in any of the other tools. Now Yosys performs perfect in-sample. It is
likely that there are bugs in Yosys that are exposed by other regressions
tests. If anyone with access to different test cases is reading this: I would
be delighted to gain access to those test cases.</p>

@footer@

